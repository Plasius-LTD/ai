name: CD (Publish to npm)

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: true
        type: choice
        default: patch
        options:
          - patch
          - minor
          - major
          - none
      preid:
        description: "Pre-release id (e.g. beta, rc). Leave blank for stable"
        required: false
        type: string

permissions:
  contents: write
  id-token: write
  attestations: write

concurrency:
  group: npm-cd-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      - name: Install deps
        run: |
          set -euo pipefail
          npm ci --no-fund --no-audit --legacy-peer-deps || npm install --no-fund --no-audit --legacy-peer-deps

      - name: Test
        run: npm run test

      - name: Prepare release metadata
        id: release
        env:
          BUMP: ${{ inputs.bump }}
          PREID: ${{ inputs.preid }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git reset --hard HEAD
          git clean -fd

          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_ACCESS=$(node -p "(require('./package.json').publishConfig||{}).access||''")
          CURRENT_VERSION=$(node -p "require('./package.json').version")

          SHOULD_PUSH="false"

          case "${BUMP:-patch}" in
            major|minor|patch)
              if [ -n "${PREID:-}" ]; then
                case "${BUMP}" in
                  major) npm version premajor --preid "${PREID}" -m "chore: release v%s [skip ci]" ;;
                  minor) npm version preminor --preid "${PREID}" -m "chore: release v%s [skip ci]" ;;
                  patch) npm version prepatch --preid "${PREID}" -m "chore: release v%s [skip ci]" ;;
                esac
              else
                npm version "${BUMP}" -m "chore: release v%s [skip ci]"
              fi
              SHOULD_PUSH="true"
              ;;
            none)
              echo "No version bump requested."
              ;;
            *)
              echo "Unknown bump type: ${BUMP}" >&2
              exit 1
              ;;
          esac

          RELEASE_VERSION=$(node -p "require('./package.json').version")

          # If version already exists on npm, keep bumping patch until free.
          # This prevents publish failures when tags/versions already exist remotely.
          while npm view "${PACKAGE_NAME}@${RELEASE_VERSION}" version --registry https://registry.npmjs.org >/dev/null 2>&1; do
            if [ "${BUMP:-patch}" = "none" ]; then
              echo "Version already exists on npm and bump=none was requested: ${PACKAGE_NAME}@${RELEASE_VERSION}" >&2
              exit 1
            fi
            echo "Version already exists on npm (${PACKAGE_NAME}@${RELEASE_VERSION}); bumping patch..."
            npm version patch -m "chore: release v%s [skip ci]"
            SHOULD_PUSH="true"
            RELEASE_VERSION=$(node -p "require('./package.json').version")
          done

          RELEASE_TAG="v${RELEASE_VERSION}"

          if ! git rev-parse "${RELEASE_TAG}" >/dev/null 2>&1; then
            git tag "${RELEASE_TAG}"
            SHOULD_PUSH="true"
          fi

          echo "package_name=${PACKAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo "package_access=${PACKAGE_ACCESS}" >> "$GITHUB_OUTPUT"
          echo "release_version=${RELEASE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "release_tag=${RELEASE_TAG}" >> "$GITHUB_OUTPUT"
          echo "should_push=${SHOULD_PUSH}" >> "$GITHUB_OUTPUT"

          echo "Prepared release ${PACKAGE_NAME}@${RELEASE_VERSION} (${RELEASE_TAG})"

      - name: Build
        run: npm run build --if-present

      - name: Generate SBOM (CycloneDX)
        id: sbom
        run: |
          set -euo pipefail
          tmp_file="$(mktemp)"
          if npm sbom --sbom-format=cyclonedx --sbom-type=library --omit dev > "$tmp_file"; then
            if [ -s "$tmp_file" ]; then
              mv "$tmp_file" sbom.cdx.json
              echo "generated=true" >> "$GITHUB_OUTPUT"
            else
              echo "SBOM output was empty; skipping SBOM attestation/upload."
              rm -f "$tmp_file" sbom.cdx.json
              echo "generated=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "SBOM generation failed; skipping SBOM attestation/upload."
            rm -f "$tmp_file" sbom.cdx.json
            echo "generated=false" >> "$GITHUB_OUTPUT"
          fi
        continue-on-error: true

      - name: Attest SBOM
        if: ${{ steps.sbom.outputs.generated == 'true' && hashFiles('sbom.cdx.json') != '' }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: sbom.cdx.json

      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          PACKAGE_ACCESS: ${{ steps.release.outputs.package_access }}
        run: |
          set -euo pipefail

          if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
            echo "NPM_TOKEN is required" >&2
            exit 1
          fi

          if [ "${PACKAGE_ACCESS}" = "public" ]; then
            npm publish --access public --provenance --registry https://registry.npmjs.org
          else
            npm publish --provenance --registry https://registry.npmjs.org
          fi

      - name: Push release commit and tag
        if: ${{ steps.release.outputs.should_push == 'true' }}
        run: |
          set -euo pipefail
          git push
          git push --tags

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.release.outputs.release_tag }}
        run: |
          set -euo pipefail

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists"
          else
            gh release create "$TAG" --title "Release $TAG" --generate-notes --latest
          fi

          if [ "${{ steps.sbom.outputs.generated }}" = "true" ] && [ -s sbom.cdx.json ]; then
            for attempt in 1 2 3; do
              if gh release upload "$TAG" sbom.cdx.json --clobber; then
                break
              fi
              if [ "$attempt" -eq 3 ]; then
                echo "SBOM upload failed after retries." >&2
                exit 1
              fi
              sleep $((attempt * 5))
            done
          else
            echo "Skipping SBOM release upload (file missing/empty or generation failed)."
          fi
